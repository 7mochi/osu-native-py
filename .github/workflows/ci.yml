name: "Build, Test and Publish"

on:
  push:
    branches:
      - master
    tags-ignore:
      - '**'
  pull_request:
    branches:
      - master

jobs:
  build-native:
    name: Build native (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win-x64
            lib_name: osu.Native.dll
          - os: macos-latest
            platform: osx-arm64
            lib_name: osu.Native.dylib
          - os: ubuntu-latest
            platform: linux-x64
            lib_name: osu.Native.so

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build osu-native
        run: dotnet publish osu-native/osu.Native -c Release -r ${{ matrix.platform }} -o build/generated

      - name: Copy cabinet.h
        shell: bash
        run: cp osu-native/Artifacts/bin/osu.Native/release_${{ matrix.platform }}/cabinet.h build/generated/

      - name: Fix cabinet header
        run: python scripts/fix_cabinet_header.py

      - name: Upload native artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.platform }}
          path: |
            build/generated/${{ matrix.lib_name }}
            build/generated/cabinet.h

  build-wheel:
    name: Build Python wheel
    runs-on: ubuntu-latest
    needs: [build-native]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry ctypesgen

      - name: Download all native artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: artifacts/

      - name: Organize native libraries
        shell: bash
        run: |
          mkdir -p src/osu_native_py/native/bin/{win-x64,osx-arm64,linux-x64}
          mkdir -p build/generated

          cp artifacts/native-win-x64/osu.Native.dll src/osu_native_py/native/bin/win-x64/
          cp artifacts/native-osx-arm64/osu.Native.dylib src/osu_native_py/native/bin/osx-arm64/
          cp artifacts/native-linux-x64/osu.Native.so src/osu_native_py/native/bin/linux-x64/

          cp artifacts/native-linux-x64/cabinet.h build/generated/

      - name: Generate Python bindings
        run: |
          ctypesgen build/generated/cabinet.h \
            -l osu.Native \
            -o src/osu_native_py/native/bindings.py \
            -D "bool=char" \
            --allow-gnu-c \
            --no-macro-warnings \
            --no-gnu-types

      - name: Patch bindings for multi-platform support
        shell: bash
        run: |
          sed -i.bak 's|add_library_search_dirs(\[\])|import os, sys; from pathlib import Path; _bin_dir = Path(__file__).parent / "bin" / ("win-x64" if sys.platform == "win32" else "osx-arm64" if sys.platform == "darwin" else "linux-x64"); add_library_search_dirs([str(_bin_dir)])|' src/osu_native_py/native/bindings.py
          rm -f src/osu_native_py/native/bindings.py.bak

      - name: Build wheel
        run: poetry build -f wheel

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel
          path: dist/*.whl
          if-no-files-found: error
  test:
    name: Test on ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    needs: [build-wheel]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13', '3.14']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: dist/

      - name: Install wheel and dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip || true
          pip install poetry pytest pytest-cov
          pip install dist/*.whl

      - name: Run tests
        run: make test

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-wheel, test]
    if: "startsWith(github.event.head_commit.message, 'chore: publish library to pypi')"
    permissions:
      id-token: write

    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
